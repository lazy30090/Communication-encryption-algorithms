# SM4分组密码算法学习报告

## 1. 算法概述

SM4分组密码算法（原GB/T 32907-2016） 是中国国家标准规定的一种商用分组密码算法。它是一种迭代式分组密码，采用非线性迭代结构。

### 1.1 核心参数

在深入了解其原理之前，首先要掌握它的几个关键参数：

- **分组长度 (Block Length):** 128比特 (bits)。SM4一次只能处理128比特的数据块。
- **密钥长度 (Key Length):** 128比特 (bits)。
- **迭代轮数 (Rounds):** 32轮。加密和密钥扩展都执行32轮迭代。
- **基本运算单位 (Word):** 32比特。因此，一个128比特的分组可以被视为4个32比特的“字”。

### 1.2 算法结构

SM4算法主要由两部分构成：

1. **数据加密/解密算法：** 用于处理明文和密文。
2. **密钥扩展算法 (Key Expansion)：** 用于从128比特的原始密钥生成32个用于每一轮加密的“轮密钥”。

一个非常关键的特点是：**解密算法与加密算法的结构完全相同**，唯一的区别在于轮密钥的使用顺序。解密时，轮密钥是加密时轮密钥的逆序。这大大简化了算法的实现。

## 2. SM4 加密原理

SM4的加密过程就是对128比特的明文分组进行32轮迭代运算，最后再进行一次反序变换。

### 2.1 准备工作

1. **输入：** 128比特的明文 `P`。
2. **分组：** 将 `P` 视为4个32比特的字，记为 `(X_0, X_1, X_2, X_3)`。
3. **轮密钥：** 128比特的加密密钥 `MK` 通过“密钥扩展算法”（见第4节）生成32个32比特的轮密钥 `(rk_0, rk_1, ..., rk_31)`。

### 2.2 32轮迭代加密

加密的核心是迭代。从 `i=0` 到 `31`，SM4重复执行以下运算：

```
X_{i+4} = F(X_i, X_{i+1}, X_{i+2}, X_{i+3}, rk_i)
```

这个公式是理解SM4的关键。它意味着：

- **输入：** 当前状态下的4个字 `(X_i, X_{i+1}, X_{i+2}, X_{i+3})` 和第 `i` 个轮密钥 `rk_i`。
- **输出：** 1个新的32比特的字 `X_{i+4}`。
- **状态更新：** 在下一轮（第 `i+1` 轮）中，输入将变为 `(X_{i+1}, X_{i+2}, X_{i+3}, X_{i+4})`。

这个过程就像一个队列，每轮计算出一个新字加入队尾，同时队首的旧字被舍弃。

### 2.3 轮函数 `F`

轮函数 `F` 是SM4算法的核心，它实现了“混淆”和“扩散”。其结构如下：

```
F(X_0, X_1, X_2, X_3, rk) = X_0 ⊕ T(X_1 ⊕ X_2 ⊕ X_3 ⊕ rk)
```

1. 将 `X_1`, `X_2`, `X_3` 和轮密钥 `rk_i` 进行32位异或（`⊕`）。
2. 将异或的结果送入一个可逆的**合成置换 `T`** 中进行处理。
3. 最后，将 `T` 函数的输出与 `X_0` 进行异或，得到本轮的最终输出 `X_{i+4}`。

### 2.4 合成置换 `T`

合成置换 `T` 负责实现非线性变换，是算法安全性的基石。它由两步复合而成：`T(.) = L(τ(.))`。

1. **非线性变换 `τ` (S盒置换):**
   - 这一步的目的是**混淆 (Confusion)**。
   - 它将输入的32比特字 `A` 分成4个8比特的字节 `(a_0, a_1, a_2, a_3)`。
   - 将这4个字节并行地送入同一个S盒（S-box）中进行查找替换。
   - S盒是一个固定的8比特输入、8比特输出的置换表。
   - 输出为 `(b_0, b_1, b_2, b_3) = (Sbox(a_0), Sbox(a_1), Sbox(a_2), Sbox(a_3))`。
   - 最后再将4个字节合并回32比特的字 `B`。
2. **线性变换 `L` (线性扩散):**
   - 这一步的目的是**扩散 (Diffusion)**，即将S盒输出的变化扩散到整个32比特字。
   - 它对S盒的输出 `B` 进行一系列的异或（`⊕`）和循环左移（`<<<`）操作。
   - `L(B) = B ⊕ (B <<< 2) ⊕ (B <<< 10) ⊕ (B <<< 18) ⊕ (B <<< 24)`

### 2.5 反序变换 `R`

经过32轮迭代后，我们得到状态 `(X_32, X_33, X_34, X_35)`。 最后一步是执行一次反序变换 `R`，将这4个字的顺序颠倒，得到最终的128比特密文 `(Y_0, Y_1, Y_2, Y_3)`。

```
(Y_0, Y_1, Y_2, Y_3) = R(X_32, X_33, X_34, X_35) = (X_35, X_34, X_33, X_32)
```

## 3. SM4 解密原理

SM4的解密过程非常简单：

- **算法结构：** 与加密算法的结构完全相同。
- **轮密钥：** 使用的轮密钥顺序与加密时**相反**。即，解密时使用的轮密钥序列为 `(rk_31, rk_30, ..., rk_0)`。

将128比特的密文 `(Y_0, Y_1, Y_2, Y_3)` 作为解密算法的输入，执行相同的32轮迭代（但使用逆序的轮密钥）和反序变换，即可得到原始的明文 `(X_0, X_1, X_2, X_3)`。

## 4. 密钥扩展算法

密钥扩展算法的目的是从128比特的原始密钥（`MK`） 生成加密所需的32个32比特轮密钥 `(rk_0, ..., rk_31)`。

1. **输入：**
   - 128比特密钥 `MK`，视为4个32比特字 `(MK_0, MK_1, MK_2, MK_3)`。
   - **系统参数 `FK`**：4个固定的32比特字。
   - **固定参数 `CK`**：32个固定的32比特字。
2. **步骤：**
   - 首先，将原始密钥 `MK` 与系统参数 `FK` 异或，得到 `(K_0, K_1, K_2, K_3)`。
   - 然后，通过32轮迭代生成所有的轮密钥 `rk_i`。第 `i` 个轮密钥 `rk_i` 的生成公式为： `rk_i = K_{i+4} = K_i ⊕ T'(K_{i+1} ⊕ K_{i+2} ⊕ K_{i+3} ⊕ CK_i)`
3. **`T'` 变换：**
   - 注意，这里的 `T'` 变换与加密时的 `T` 变换**不同**。
   - `T'` 同样由 S盒非线性变换 `τ` 和 线性变换 `L'` 复合而成。
   - 它使用**相同**的S盒 `τ`。
   - 但它使用一个**不同**的线性变换 `L'`： `L'(B) = B ⊕ (B <<< 13) ⊕ (B <<< 23)`